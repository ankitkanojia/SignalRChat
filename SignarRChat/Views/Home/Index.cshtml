@{
    ViewBag.Title = "Chat";
}

<div id="sidepanel">
    <div id="contacts">
        <ul id="onlineUsers">
            <li class="contact">
                @*<div class="wrap">
                        <span class="contact-status online"></span>
                        <img src="http://emilcarlsson.se/assets/louislitt.png" alt="" />
                        <div class="meta">
                            <p class="name">Louis Litt</p>
                        </div>
                    </div>*@
            </li>
        </ul>
    </div>
    <div id="bottom-bar">
        <button id="addcontact"><i class="fa fa-users fa-fw" aria-hidden="true"></i> <span>Online User(s)</span></button>
    </div>
</div>

<div class="content">
    <div class="messages">
        <input type="hidden" id="displayname" />
        <ul id="discussion">
            @*<li class="sent">
                    <img src="http://emilcarlsson.se/assets/mikeross.png" alt="" />
                    <p>What are you talking about? You do what they say or they shoot you.</p>
                </li>
                <li class="replies">
                    <img src="http://emilcarlsson.se/assets/harveyspecter.png" alt="" />
                    <p>Wrong. You take the gun, or you pull out a bigger one. Or, you call their bluff. Or, you do any one of a hundred and forty six other things.</p>
                </li>*@
        </ul>
    </div>
    <div class="message-input">
        <div class="wrap">
            <input id="message" type="text" placeholder="Write your message..." />
            <button class="submit" type="button" id="sendmessage" value="Send"><i class="fa fa-paper-plane" aria-hidden="true"></i></button>
        </div>
    </div>
</div>


@section Scripts{

    <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <script>

        $(window).on('keydown', function (e) {
            if (e.which == 13) {
                $('#sendmessage').click();
                return false;
            }
        });

        $(function () {

            setInterval(GetConnections, 3000);

            $(".messages").animate({ scrollTop: $(document).height() }, "fast");

            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.chatHub;

            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message) {
                if ($('#displayname').val().toLowerCase().trim() === name.toLowerCase().trim()) {
                    $('<li class="replies"><span>' + name +'</span><p>' + htmlEncode(message) + '</p></li>').appendTo($('.messages ul'));
                    $('.contact.active .preview').html('<span>You: </span>' + message);
                    $(".messages").animate({ scrollTop: $(document).height() }, "fast");
                } else {
                    $('<li class="sent"><span>' + name +'</span><p>' + message + '</p></li>').appendTo($('.messages ul'));
                    $('.contact.active .preview').html('<span>You: </span>' + message);
                    $(".messages").animate({ scrollTop: $(document).height() }, "fast");
                }

                //// Add the message to the page.
                //$('#discussion').append('<li><strong>' + htmlEncode(name)
                //    + '</strong>: ' + htmlEncode(message) + '</li>');
            };

            // Get the user name and store it to prepend to messages.
            var person = prompt('Enter your name:', '');

            if (person != null) {
                $.connection.hub.qs = { 'UserName': person };
                $('#displayname').val(person);

                // Set initial focus to message input box.
                $('#message').focus();
                // Start the connection.
                $.connection.hub.start().done(function () {
                    $('#sendmessage').click(function () {
                        var message = $("#message").val();
                        if ($.trim(message) == '') {
                            return false;
                        } else {
                            // Call the Send method on the hub.
                            chat.server.send($('#displayname').val(), message);
                            // Clear text box and reset focus for next comment.
                            $('#message').val('').focus();
                        }
                    });
                });
            }
        });

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

        var imagesList = ["http://emilcarlsson.se/assets/louislitt.png",
            "http://emilcarlsson.se/assets/harveyspecter.png",
            "http://emilcarlsson.se/assets/rachelzane.png",
            "http://emilcarlsson.se/assets/donnapaulsen.png",
            "http://emilcarlsson.se/assets/jessicapearson.png",
            "http://emilcarlsson.se/assets/haroldgunderson.png",
            "http://emilcarlsson.se/assets/danielhardman.png",
            "http://emilcarlsson.se/assets/katrinabennett.png",
            "http://emilcarlsson.se/assets/charlesforstman.png",
            "http://emilcarlsson.se/assets/jonathansidwell.png"];

        function GetConnections(){
            $.get('@Url.Action("GetConnections","Home")', function (data) {
                if (data.ConnectionDetails && data.ConnectionDetails.length > 0) {
                    $("#onlineUsers").html('');
                    $.each(data.ConnectionDetails, function (e, element) {
                        if ($('#displayname').val().toLowerCase().trim() !== element.UserName.toLowerCase().trim()) {
                            $("#onlineUsers").append('<li class="contact"><div class="wrap"><span class="contact-status online"></span><img src="' + imagesList[e] + '" alt="" /><div class="meta"><p class="name">' + element.UserName + '</p></div></div></li>');
                        }
                    });
                }
            });
        }
    </script>
}